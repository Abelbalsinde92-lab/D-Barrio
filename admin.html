<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>D'BARRIO ADMIN</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#F9A825">
<link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root{--y:#F9A825;--yb:#FFD700;--bg:#000;--card:#111;--card2:#1a1a1a;--border:#2a2a2a;--text:#fff;--sub:#aaa;--red:#ff4444;--green:#00d856}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto Condensed',sans-serif;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;padding-bottom:80px}
.hdr{background:var(--card);border-bottom:3px solid var(--y);padding:14px 18px;position:sticky;top:0;z-index:100;display:flex;justify-content:space-between;align-items:center}
.hdr-logo{font-size:1.2rem;font-weight:900;color:var(--y);text-transform:uppercase}
.hdr-back{background:rgba(249,168,37,.15);border:2px solid var(--y);color:var(--y);padding:7px 14px;font-size:.75rem;font-weight:900;cursor:pointer;text-transform:uppercase;text-decoration:none}
.tabs{background:var(--card);border-bottom:3px solid var(--border);display:flex;overflow-x:auto;position:sticky;top:55px;z-index:99;scrollbar-width:none}
.tab{padding:13px 8px;font-size:.65rem;font-weight:900;white-space:nowrap;text-transform:uppercase;color:var(--sub);border-bottom:3px solid transparent;cursor:pointer;flex:1;text-align:center;min-width:65px;position:relative}
.tab.on{color:var(--y);border-bottom-color:var(--y)}
.tab .badge-count{position:absolute;top:6px;right:4px;background:var(--red);color:#fff;border-radius:50%;width:16px;height:16px;font-size:.55rem;display:flex;align-items:center;justify-content:center;font-weight:900}
.content{padding:18px;max-width:1200px;margin:0 auto}
.sec{display:none}.sec.on{display:block}
h2{color:var(--y);font-size:1.3rem;font-weight:900;text-transform:uppercase;border-bottom:3px solid var(--y);padding-bottom:8px;margin-bottom:18px}
.stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:22px}
@media(min-width:600px){.stats{grid-template-columns:repeat(4,1fr)}}
.stat{background:var(--card2);border:3px solid var(--border);padding:16px;text-align:center}
.stat-val{font-size:2rem;font-weight:900;color:var(--y);line-height:1}
.stat-lbl{font-size:.6rem;color:var(--sub);text-transform:uppercase;letter-spacing:1px;margin-top:5px;font-weight:700}
.card{background:var(--card);border:3px solid var(--border);margin-bottom:12px;box-shadow:0 4px 0 #000}
.card.hl{border-color:var(--y);box-shadow:0 4px 0 #c17900}
.card.cand{border-color:#0088ff;box-shadow:0 4px 0 #005cb2}
.card.queja{border-color:var(--red);box-shadow:0 4px 0 #8b0000}
.card-hdr{padding:15px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;gap:10px}
.card-title{font-weight:900;font-size:.95rem;text-transform:uppercase;color:#fff}
.card-sub{font-size:.7rem;color:var(--sub);margin-top:3px}
.card-body{padding:0 15px;max-height:0;overflow:hidden;transition:max-height .4s ease,padding .3s ease}
.card.open .card-body{padding:15px;max-height:5000px}
.arrow{color:var(--y);font-size:.9rem;transition:transform .3s;flex-shrink:0}
.card.open .arrow{transform:rotate(180deg)}
.badge{padding:4px 10px;font-size:.62rem;font-weight:900;text-transform:uppercase;flex-shrink:0}
.badge-y{background:var(--y);color:#000}
.badge-r{background:var(--red);color:#fff}
.badge-g{background:var(--green);color:#000}
.badge-o{background:#ff9500;color:#000}
.pulse{animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
.fld{margin-bottom:12px}
.fld label{display:block;font-size:.62rem;font-weight:900;color:var(--sub);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px}
.fld input,.fld select,.fld textarea{width:100%;background:#000;border:2px solid var(--border);color:#fff;padding:12px;font-family:'Roboto Condensed',sans-serif;font-size:.9rem;font-weight:700}
.btn{padding:12px 16px;border:none;font-family:'Roboto Condensed',sans-serif;font-weight:900;font-size:.85rem;cursor:pointer;text-transform:uppercase;display:block;width:100%;margin:5px 0}
.btn-y{background:var(--y);color:#000;box-shadow:0 4px 0 #c17900}
.btn-g{background:transparent;border:2px solid var(--green);color:var(--green)}
.btn-r{background:rgba(255,68,68,.15);border:2px solid var(--red);color:var(--red)}
.btn-orange{background:#ff9500;color:#000}
.irow{display:flex;justify-content:space-between;align-items:flex-start;padding:9px 0;border-bottom:1px solid var(--border);gap:10px}
.money{color:var(--y);font-weight:900;font-size:1.05rem}
.sep{border:none;border-top:2px solid var(--border);margin:14px 0}
.cfg-box{background:var(--card2);border:3px solid var(--y);padding:20px;margin-bottom:18px}
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%);background:var(--y);color:#000;padding:13px 22px;font-weight:900;font-size:.9rem;z-index:9999;display:none;text-align:center;min-width:240px}
.toast.err{background:var(--red);color:#fff}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.97);z-index:600;display:none;align-items:flex-start;justify-content:center;overflow-y:auto;padding:20px}
.modal-overlay.open{display:flex}
.modal-box{background:var(--card);border:3px solid var(--y);width:100%;max-width:440px;margin:auto}
.rank{background:var(--y);color:#000;width:24px;height:24px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:900}
</style>
</head>
<body>

<div class="toast" id="toast"></div>

<div class="modal-overlay" id="modal-candidato">
  <div class="modal-box">
    <div class="modal-top" style="background:var(--y);padding:15px;display:flex;justify-content:space-between;align-items:center">
        <h3 style="color:#000">ğŸ‘· REGISTRAR SOCIO</h3>
        <button onclick="closeOverlay('modal-candidato')" style="background:#000;color:var(--y);border:none;padding:5px 10px;font-weight:900">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="fld"><label>Nombre</label><input type="text" id="m-nom"></div>
      <div class="fld"><label>WhatsApp</label><input type="tel" id="m-tel"></div>
      <div class="fld"><label>Zona</label><input type="text" id="m-zon"></div>
      <div class="fld"><label>Especialidad</label>
        <select id="m-esp">
          <option>ğŸš° PlomerÃ­a</option><option>âš¡ Electricidad</option><option>ğŸ”¨ CarpinterÃ­a</option><option>ğŸ§± AlbaÃ±ilerÃ­a</option><option>ğŸ¨ Pintura</option><option>â„ï¸ RefrigeraciÃ³n</option><option>ğŸ”‘ CerrajerÃ­a</option><option>ğŸ’» TecnologÃ­a</option><option>ğŸ”§ Multiservicios</option>
        </select>
      </div>
      <div class="fld"><label>PIN (4 dÃ­gitos)</label><input type="password" id="m-pin" maxlength="4" inputmode="numeric"></div>
      <div class="fld"><label>ComisiÃ³n (%)</label><input type="number" id="m-com" value="15"></div>
      <input type="hidden" id="m-candidato-id">
      <button class="btn btn-y" onclick="registrarSocio()">âœ… CONFIRMAR REGISTRO</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-orden">
  <div class="modal-box">
    <div class="modal-top" style="background:var(--y);padding:15px;display:flex;justify-content:space-between;align-items:center">
        <h3 style="color:#000">ğŸ“ ORDEN MANUAL</h3>
        <button onclick="closeOverlay('modal-orden')" style="background:#000;color:var(--y);border:none;padding:5px 10px;font-weight:900">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="fld"><label>Cliente</label><input type="text" id="o-nom"></div>
      <div class="fld"><label>WhatsApp</label><input type="tel" id="o-tel" placeholder="+53..."></div>
      <div class="fld"><label>DirecciÃ³n</label><input type="text" id="o-dir"></div>
      <div class="fld"><label>Servicio</label><select id="o-serv">
          <option>ğŸš° PlomerÃ­a</option><option>âš¡ Electricidad</option><option>ğŸ”¨ CarpinterÃ­a</option><option>â„ï¸ RefrigeraciÃ³n</option><option>ğŸ”§ Otro</option>
      </select></div>
      <div class="fld"><label>Detalles</label><textarea id="o-det" rows="3"></textarea></div>
      <button class="btn btn-y" onclick="crearOrdenManual()">ğŸ’¾ CREAR ORDEN</button>
    </div>
  </div>
</div>

<div class="hdr">
  <button class="hdr-back" onclick="logout()">â† SALIR</button>
  <div class="hdr-logo">D'BARRIO ADMIN</div>
  <div style="width:72px"></div>
</div>

<div class="tabs">
  <div class="tab on" onclick="showTab('dashboard')">ğŸ“Š DASH</div>
  <div class="tab" onclick="showTab('candidatos')">ğŸ‘· CAND<span class="badge-count" id="cnt-cand" style="display:none">0</span></div>
  <div class="tab" onclick="showTab('ordenes')">ğŸ“‹ Ã“RDS<span class="badge-count" id="cnt-ord" style="display:none">0</span></div>
  <div class="tab" id="tab-quejas" onclick="showTab('quejas')">âš ï¸ RECLAM<span class="badge-count pulse" id="cnt-queja" style="display:none">0</span></div>
  <div class="tab" onclick="showTab('archivo')">ğŸ“¦ ARCH</div>
  <div class="tab" onclick="showTab('deudas')">ğŸ’° DEU</div>
  <div class="tab" onclick="showTab('socios')">ğŸ‘¥ SOC</div>
  <div class="tab" onclick="showTab('config')">âš™ï¸ CFG</div>
</div>

<div class="content">
  <div id="sec-dashboard" class="sec on">
    <h2>ğŸ“Š Dashboard</h2>
    <div class="stats">
      <div class="stat"><div class="stat-val" id="d-total">â€”</div><div class="stat-lbl">Ã“rdenes</div></div>
      <div class="stat"><div class="stat-val" id="d-pend" style="color:var(--red)">â€”</div><div class="stat-lbl">Pendientes</div></div>
      <div class="stat"><div class="stat-val" id="d-socios">â€”</div><div class="stat-lbl">Socios</div></div>
      <div class="stat"><div class="stat-val" id="d-comp">â€”</div><div class="stat-lbl">Completadas</div></div>
    </div>
    <h2>â­ Top Socios (Rating)</h2>
    <div id="topSocios"><p class="empty">Cargando...</p></div>
  </div>

  <div id="sec-quejas" class="sec">
    <h2>âš ï¸ Reclamaciones</h2>
    <div id="listaQuejas"><p class="empty">Cargando...</p></div>
  </div>

  <div id="sec-ordenes" class="sec">
    <h2>ğŸ“‹ Ã“rdenes</h2>
    <button class="btn btn-orange" style="margin-bottom:16px" onclick="openModal('modal-orden')">â• CREAR MANUAL</button>
    <div id="listaOrdenes"><p class="empty">Cargando...</p></div>
  </div>

  <div id="sec-archivo" class="sec">
    <h2>ğŸ“¦ Archivo (GarantÃ­as)</h2>
    <div id="listaArchivo"><p class="empty">Cargando...</p></div>
  </div>

  <div id="sec-candidatos" class="sec"><div id="listaCandidatos"></div></div>
  <div id="sec-deudas" class="sec"><div id="listaDeudas"></div></div>
  <div id="sec-socios" class="sec"><div id="listaSocios"></div></div>
  
  <div id="sec-config" class="sec">
    <h2>âš™ï¸ ConfiguraciÃ³n</h2>
    <div class="cfg-box">
      <h3>ğŸ’° ComisiÃ³n Global</h3>
      <div class="fld"><label>%</label><input type="number" id="cfg-com" value="15"></div>
      <button class="btn btn-y" onclick="guardarComision()">ğŸ’¾ GUARDAR</button>
    </div>
    <div class="cfg-box">
      <h3>ğŸ“± WhatsApp Admin</h3>
      <div class="fld"><label>NÃºmero</label><input type="tel" id="cfg-owner" placeholder="+53..."></div>
      <button class="btn btn-y" onclick="guardarNotif()">ğŸ’¾ GUARDAR</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL='https://jtorpamexbjxnomngfwq.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0b3JwYW1leGJqeG5vbW5nZndxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MjE2MjMsImV4cCI6MjA4Njk5NzYyM30.Tzun90wyUfPYb8K8WxmziwlKyJS8kY1K_zzrZNh7R-8';
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

if(!localStorage.getItem('db_admin'))window.location.href='index.html';

// FUNCIONES BASE
function ct(t){return(t||'').replace(/[\s\-\(\)\+]/g,'')}
function money(n){return'$'+(parseFloat(n)||0).toFixed(2)}
function toast(msg,err=false){const t=document.getElementById('toast');t.textContent=msg;t.className='toast'+(err?' err':'');t.style.display='block';setTimeout(()=>t.style.display='none',3000)}
function toggleCard(id){const c=document.getElementById(id);c.classList.toggle('open')}
function closeOverlay(id){document.getElementById(id).classList.remove('open')}
function openModal(id){document.getElementById(id).classList.add('open')}

// GARANTÃAS (RESTAURADO)
function enviarGarantiaCliente(cliente, telefono, servicio, codigo) {
  const expira = new Date(); expira.setDate(expira.getDate() + 30);
  const fExp = expira.toLocaleDateString('es-ES');
  const msg = `ğŸ”° *GARANTÃA D'BARRIO*\n\nHola *${cliente}*,\nTu servicio de *${servicio}* tiene garantÃ­a.\n\nğŸ“Œ *CÃ³digo:* ${codigo}\nğŸ“… *Vence:* ${fExp}`;
  window.open(`https://wa.me/${ct(telefono)}?text=${encodeURIComponent(msg)}`, '_blank');
}

// NAVEGACIÃ“N
function showTab(id){
  document.querySelectorAll('.sec').forEach(s=>s.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
  document.getElementById('sec-'+id).classList.add('on');
  event.currentTarget.classList.add('on');
  if(id==='dashboard')renderDash();
  if(id==='quejas')renderQuejas();
  if(id==='ordenes')renderOrdenes();
  if(id==='archivo')renderArchivo();
  if(id==='candidatos')renderCandidatos();
  if(id==='deudas')renderDeudas();
  if(id==='socios')renderSocios();
  if(id==='config')cargarConfig();
}

// RENDERIZADO DE Ã“RDENES (CON ASIGNACIÃ“N RESTAURADA)
async function renderOrdenes(){
  const c = document.getElementById('listaOrdenes');
  const {data:sol} = await sb.from('solicitudes').select('*').eq('estado','pendiente').order('created_at',{ascending:false});
  const {data:socs} = await sb.from('socios').select('id,nombre,especialidad');
  
  if(!sol?.length){ c.innerHTML = '<p class="empty">No hay Ã³rdenes pendientes</p>'; return; }
  
  c.innerHTML = sol.map(o => {
    const opcs = socs?.map(s => `<option value="${s.id}" ${o.socio_asignado===s.id?'selected':''}>${s.nombre} (${s.especialidad})</option>`).join('');
    return `
    <div class="card hl" id="ord-${o.id}">
      <div class="card-hdr" onclick="toggleCard('ord-${o.id}')">
        <div><div class="card-title">${o.cliente}</div><div class="card-sub">${o.servicio}</div></div>
        <span class="badge ${o.socio_asignado?'badge-o':'badge-r pulse'}">${o.socio_asignado?'ASIGNADO':'PEND'}</span>
      </div>
      <div class="card-body">
        <div class="irow"><span class="ilbl">DirecciÃ³n</span><span class="ival">${o.direccion}</span></div>
        <div class="fld" style="margin-top:10px"><label>Asignar Socio</label><select id="sel-${o.id}"><option value="">-- Elegir --</option>${opcs}</select></div>
        <button class="btn btn-y" onclick="asignarSocio('${o.id}')">ğŸ“¤ ACTUALIZAR ASIGNACIÃ“N</button>
        <button class="btn btn-g" onclick="completarOrden('${o.id}')">âœ… COMPLETAR</button>
      </div>
    </div>`;
  }).join('');
}

async function asignarSocio(oid){
    const sid = document.getElementById('sel-'+oid).value;
    if(!sid) return toast('Elige un socio', true);
    await sb.from('solicitudes').update({socio_asignado: sid}).eq('id', oid);
    toast('Socio asignado correctamente');
    renderOrdenes();
}

// RESTO DE FUNCIONES (QUEJAS, DASH, ARCHIVO)
async function renderQuejas(){
  const c = document.getElementById('listaQuejas');
  const {data} = await sb.from('quejas').select('*').eq('estado','pendiente');
  if(!data?.length){ c.innerHTML = '<p class="empty">Sin reclamaciones</p>'; return; }
  c.innerHTML = data.map(q => `
    <div class="card queja" id="q-${q.id}">
      <div class="card-hdr" onclick="toggleCard('q-${q.id}')">
        <div><div class="card-title">âš ï¸ RECLAMO: ${q.telefono}</div><div class="card-sub">${q.fecha}</div></div>
      </div>
      <div class="card-body">
        <p style="margin-bottom:10px">"${q.mensaje}"</p>
        <button class="btn btn-g" onclick="window.open('https://wa.me/${ct(q.telefono)}')">ğŸ’¬ CONTACTAR</button>
        <button class="btn btn-y" onclick="resolverQueja('${q.id}')">âœ… RESUELTO</button>
      </div>
    </div>`).join('');
}

async function resolverQueja(id){
    await sb.from('quejas').update({estado: 'resuelto'}).eq('id', id);
    renderQuejas(); initContadores();
}

async function renderArchivo(){
    const c = document.getElementById('listaArchivo');
    const {data} = await sb.from('solicitudes').select('*').eq('estado','completada').limit(20);
    c.innerHTML = data?.map(o => {
        const codG = o.codigo_garantia || 'DB-'+o.id.toString().slice(-4).toUpperCase();
        return `<div class="card">
            <div class="card-hdr">
                <div><div class="card-title">${o.cliente}</div><div class="card-sub">${o.servicio}</div></div>
                <span class="badge badge-g">OK</span>
            </div>
            <div class="card-body" style="display:block;max-height:none;padding:15px">
                <button class="btn btn-y" onclick="enviarGarantiaCliente('${o.cliente}','${o.telefono}','${o.servicio}','${codG}')">âœ‰ï¸ ENVIAR GARANTÃA</button>
            </div>
        </div>`;
    }).join('');
}

async function renderDash(){
    const {data:sol} = await sb.from('solicitudes').select('estado');
    const {data:soc} = await sb.from('socios').select('*').order('rating',{ascending:false});
    document.getElementById('d-total').textContent = sol?.length || 0;
    document.getElementById('d-pend').textContent = sol?.filter(o=>o.estado==='pendiente').length || 0;
    document.getElementById('d-socios').textContent = soc?.length || 0;
    document.getElementById('topSocios').innerHTML = soc?.slice(0,5).map((s,i)=>`
        <div class="card"><div class="card-hdr">
            <div style="display:flex;align-items:center;gap:10px"><span class="rank">${i+1}</span>
            <div><div class="card-title">${s.nombre}</div><div class="card-sub">${'â­'.repeat(Math.round(s.rating))} (${s.rating})</div></div></div>
        </div></div>`).join('');
}

// CONFIGURACIÃ“N (RESTAURADO)
async function cargarConfig(){
    const {data:c} = await sb.from('config').select('*');
    c?.forEach(item => {
        if(item.clave==='comision_global') document.getElementById('cfg-com').value = item.valor;
        if(item.clave==='telefono_admin') document.getElementById('cfg-owner').value = item.valor;
    });
}
async function guardarComision(){ 
    await sb.from('config').upsert({clave:'comision_global', valor:document.getElementById('cfg-com').value});
    toast('ComisiÃ³n guardada');
}
async function guardarNotif(){ 
    await sb.from('config').upsert({clave:'telefono_admin', valor:document.getElementById('cfg-owner').value});
    toast('WhatsApp guardado');
}

async function initContadores(){
  const {count:nO} = await sb.from('solicitudes').select('*',{count:'exact',head:true}).eq('estado','pendiente');
  const {count:nQ} = await sb.from('quejas').select('*',{count:'exact',head:true}).eq('estado','pendiente');
  document.getElementById('cnt-ord').textContent = nO;
  document.getElementById('cnt-ord').style.display = nO>0?'flex':'none';
  document.getElementById('cnt-queja').textContent = nQ;
  document.getElementById('cnt-queja').style.display = nQ>0?'flex':'none';
}

function logout(){localStorage.removeItem('db_admin');window.location.href='index.html'}

initContadores(); renderDash();
</script>
</body>
</html>
