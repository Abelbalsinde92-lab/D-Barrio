<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>D'BARRIO ADMIN</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#F9A825">
<link rel="apple-touch-icon" href="icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root{--y:#F9A825;--yb:#FFD700;--bg:#000;--card:#111;--card2:#1a1a1a;--border:#2a2a2a;--text:#fff;--sub:#aaa;--red:#ff4444;--green:#00d856}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto Condensed',sans-serif;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;padding-bottom:80px}
/* Header */
.hdr{background:var(--card);border-bottom:3px solid var(--y);padding:14px 18px;position:sticky;top:0;z-index:100;display:flex;justify-content:space-between;align-items:center}
.hdr-logo{font-size:1.2rem;font-weight:900;color:var(--y);letter-spacing:-1px;text-transform:uppercase}
.hdr-logo span{color:#fff}
.hdr-back{background:rgba(249,168,37,.15);border:2px solid var(--y);color:var(--y);padding:7px 14px;font-size:.75rem;font-weight:900;text-decoration:none;text-transform:uppercase;cursor:pointer}
/* Tabs */
.tabs{background:var(--card);border-bottom:3px solid var(--border);display:flex;overflow-x:auto;position:sticky;top:55px;z-index:99;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab{padding:13px 10px;font-size:.68rem;font-weight:900;white-space:nowrap;text-transform:uppercase;color:var(--sub);border-bottom:3px solid transparent;cursor:pointer;flex:1;text-align:center;min-width:60px}
.tab.on{color:var(--y);border-bottom-color:var(--y)}
/* Contenido */
.content{padding:18px;max-width:1200px;margin:0 auto}
.sec{display:none}.sec.on{display:block}
h2{color:var(--y);font-size:1.3rem;font-weight:900;text-transform:uppercase;border-bottom:3px solid var(--y);padding-bottom:8px;margin-bottom:18px}
/* Stats */
.stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:22px}
@media(min-width:600px){.stats{grid-template-columns:repeat(4,1fr)}}
.stat{background:var(--card2);border:3px solid var(--border);padding:16px;text-align:center}
.stat-val{font-size:2rem;font-weight:900;color:var(--y);line-height:1}
.stat-lbl{font-size:.6rem;color:var(--sub);text-transform:uppercase;letter-spacing:1px;margin-top:5px;font-weight:700}
/* Cards */
.card{background:var(--card);border:3px solid var(--border);margin-bottom:12px;box-shadow:0 4px 0 #000}
.card.hl{border-color:var(--y);box-shadow:0 4px 0 #c17900,0 6px 20px rgba(249,168,37,.2)}
.card-hdr{padding:15px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;gap:10px}
.card-hdr:active{background:#0a0a0a}
.card-title{font-weight:900;font-size:.95rem;text-transform:uppercase;color:#fff}
.card-sub{font-size:.7rem;color:var(--sub);margin-top:3px}
.card-body{padding:0 15px;max-height:0;overflow:hidden;transition:all .35s ease}
.card.open .card-body{padding:15px;max-height:4000px}
.arrow{color:var(--y);font-size:.9rem;transition:transform .3s;flex-shrink:0}
.card.open .arrow{transform:rotate(180deg)}
.badge{padding:4px 10px;font-size:.62rem;font-weight:900;text-transform:uppercase;flex-shrink:0}
.badge-y{background:var(--y);color:#000}
.badge-r{background:var(--red);color:#fff;animation:pulse 2s infinite}
.badge-g{background:var(--green);color:#000}
.badge-o{background:#ff9500;color:#000}
.badge-b{background:#0088ff;color:#fff}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
/* Dot disponibilidad */
.dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.dot-g{background:var(--green)}
.dot-r{background:var(--red)}
/* Formularios */
.fld{margin-bottom:12px}
.fld label{display:block;font-size:.62rem;font-weight:900;color:var(--sub);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px}
.fld input,.fld select,.fld textarea{width:100%;background:#000;border:2px solid var(--border);color:#fff;padding:12px;font-family:'Roboto Condensed',sans-serif;font-size:.9rem;font-weight:700}
.fld input:focus,.fld select:focus,.fld textarea:focus{outline:none;border-color:var(--y);box-shadow:0 0 0 3px rgba(249,168,37,.2)}
.fld select option{background:#111;color:#fff}
/* Botones */
.btn{padding:12px 18px;border:none;font-family:'Roboto Condensed',sans-serif;font-weight:900;font-size:.85rem;cursor:pointer;text-transform:uppercase;display:inline-block;margin:4px}
.btn-y{background:var(--y);color:#000;box-shadow:0 4px 0 #c17900;width:100%;margin:6px 0}
.btn-y:active{transform:translateY(4px);box-shadow:none}
.btn-g{background:transparent;border:2px solid var(--green);color:var(--green)}
.btn-b{background:transparent;border:2px solid #0088ff;color:#0088ff}
.btn-r{background:rgba(255,68,68,.15);border:2px solid var(--red);color:var(--red)}
.btn-w{background:transparent;border:2px solid var(--border);color:#fff}
/* Filas info */
.irow{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid var(--border);gap:10px}
.irow:last-child{border:none}
.ilbl{color:var(--sub);font-size:.78rem;font-weight:700;flex-shrink:0}
.ival{color:#fff;font-weight:900;font-size:.85rem;text-align:right}
.money{color:var(--y);font-weight:900;font-size:1.05rem}
/* Toast */
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%);background:var(--y);color:#000;padding:13px 22px;font-weight:900;font-size:.9rem;z-index:9999;text-align:center;min-width:240px;pointer-events:none;display:none}
.toast.err{background:var(--red);color:#fff}
/* Modal PIN */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:200;display:none;align-items:center;justify-content:center}
.overlay.open{display:flex}
.pin-box{background:var(--card);border:3px solid var(--y);padding:30px;width:90%;max-width:340px;text-align:center}
.pin-box h3{color:var(--y);font-size:1.2rem;margin-bottom:16px;text-transform:uppercase}
.pin-box input{width:100%;background:#000;border:2px solid var(--border);color:#fff;padding:14px;font-size:1.5rem;letter-spacing:6px;text-align:center;margin-bottom:14px}
/* Config box */
.cfg-box{background:var(--card2);border:3px solid var(--y);padding:20px;margin-bottom:18px}
.cfg-box h3{color:var(--y);font-size:1rem;text-transform:uppercase;margin-bottom:14px;font-weight:900}
.section-divider{border:none;border-top:2px solid var(--border);margin:20px 0}
/* Top badge ranking */
.rank{background:var(--y);color:#000;width:24px;height:24px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:900;flex-shrink:0}
</style>
</head>
<body>

<div class="toast" id="toast"></div>

<!-- Overlay PIN reset -->
<div class="overlay" id="overlay-pin">
  <div class="pin-box">
    <h3>ğŸ” PIN de Seguridad</h3>
    <input type="password" id="reset-pin" maxlength="6" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" inputmode="numeric">
    <button class="btn btn-y" onclick="confirmarReset()">CONFIRMAR</button>
    <button class="btn btn-r" style="width:100%" onclick="closeOverlay()">CANCELAR</button>
  </div>
</div>

<div class="hdr">
  <a href="index.html" class="hdr-back">â† INICIO</a>
  <div class="hdr-logo">D'BARRIO <span>ADMIN</span></div>
  <div style="width:72px"></div>
</div>

<div class="tabs">
  <div class="tab on" onclick="showTab('dashboard',this)">ğŸ“Š DASH</div>
  <div class="tab" onclick="showTab('ordenes',this)">ğŸ“‹ Ã“RDENES</div>
  <div class="tab" onclick="showTab('archivo',this)">ğŸ“¦ ARCHIVO</div>
  <div class="tab" onclick="showTab('deudas',this)">ğŸ’° DEUDAS</div>
  <div class="tab" onclick="showTab('socios',this)">ğŸ‘¥ SOCIOS</div>
  <div class="tab" onclick="showTab('config',this)">âš™ï¸ CONFIG</div>
</div>

<div class="content">

  <!-- DASHBOARD -->
  <div id="sec-dashboard" class="sec on">
    <h2>ğŸ“Š Dashboard</h2>
    <div class="stats">
      <div class="stat"><div class="stat-val" id="d-total">0</div><div class="stat-lbl">Trabajos</div></div>
      <div class="stat"><div class="stat-val" id="d-pend">0</div><div class="stat-lbl">Pendientes</div></div>
      <div class="stat"><div class="stat-val" id="d-socios">0</div><div class="stat-lbl">Socios</div></div>
      <div class="stat"><div class="stat-val" id="d-ing">$0</div><div class="stat-lbl">Ingresos</div></div>
    </div>
    <h2>â­ Top Socios</h2>
    <div id="topSocios"></div>
  </div>

  <!-- Ã“RDENES PENDIENTES -->
  <div id="sec-ordenes" class="sec">
    <h2>ğŸ“‹ Ã“rdenes Pendientes</h2>
    <div id="listaOrdenes"><p style="color:var(--sub);text-align:center;padding:30px">Cargando...</p></div>
  </div>

  <!-- ARCHIVO (RECIBOS) -->
  <div id="sec-archivo" class="sec">
    <h2>ğŸ“¦ Recibos Pendientes</h2>
    <div id="listaArchivo"><p style="color:var(--sub);text-align:center;padding:30px">Cargando...</p></div>
  </div>

  <!-- DEUDAS -->
  <div id="sec-deudas" class="sec">
    <h2>ğŸ’° Deudas de Socios</h2>
    <div id="listaDeudas"><p style="color:var(--sub);text-align:center;padding:30px">Cargando...</p></div>
  </div>

  <!-- SOCIOS -->
  <div id="sec-socios" class="sec">
    <h2>â• Nuevo Socio</h2>
    <div class="card" id="card-new-socio">
      <div class="card-hdr" onclick="toggleCard('card-new-socio')">
        <div><div class="card-title">Registrar Socio</div></div>
        <span class="arrow">â–¼</span>
      </div>
      <div class="card-body">
        <form id="formSocio">
          <div class="fld"><label>Nombre Completo</label><input type="text" id="sn-nom" required></div>
          <div class="fld"><label>WhatsApp</label><input type="tel" id="sn-tel" placeholder="+53..." required></div>
          <div class="fld"><label>Zona</label><input type="text" id="sn-zon" required></div>
          <div class="fld"><label>Especialidad</label>
            <select id="sn-esp" required>
              <option value="">Seleccionar...</option>
              <option>ğŸš° PlomerÃ­a</option><option>âš¡ Electricidad</option>
              <option>ğŸ”¨ CarpinterÃ­a</option><option>ğŸ§± AlbaÃ±ilerÃ­a</option>
              <option>ğŸ¨ Pintura</option><option>â„ï¸ RefrigeraciÃ³n</option>
              <option>ğŸ”‘ CerrajerÃ­a</option><option>ğŸ’» TecnologÃ­a</option>
              <option>ğŸ”§ Multiservicios</option>
            </select>
          </div>
          <div class="fld"><label>PIN (4 dÃ­gitos)</label><input type="password" id="sn-pin" maxlength="4" pattern="[0-9]{4}" inputmode="numeric" required></div>
          <div class="fld"><label>ComisiÃ³n (%)</label><input type="number" id="sn-com" min="0" max="100" value="15" required></div>
          <button type="submit" class="btn btn-y">ğŸ’¾ GUARDAR Y ENVIAR INVITE</button>
        </form>
      </div>
    </div>
    <h2 style="margin-top:25px">ğŸ‘¥ Lista de Socios</h2>
    <div id="listaSocios"></div>
  </div>

  <!-- CONFIG -->
  <div id="sec-config" class="sec">
    <h2>âš™ï¸ ConfiguraciÃ³n</h2>

    <div class="cfg-box">
      <h3>ğŸ’° ComisiÃ³n Global</h3>
      <p style="color:var(--sub);font-size:.85rem;margin-bottom:12px">Se aplica a socios sin comisiÃ³n individual.</p>
      <div class="fld"><label>Porcentaje (%)</label><input type="number" id="cfg-com" min="0" max="100" value="15"></div>
      <button class="btn btn-y" onclick="guardarConfig()">ğŸ’¾ GUARDAR</button>
    </div>

    <hr class="section-divider">

    <div class="cfg-box">
      <h3>ğŸ“± Notificaciones WhatsApp</h3>
      <p style="color:var(--sub);font-size:.85rem;margin-bottom:12px">Se notificarÃ¡ a estos nÃºmeros cuando llegue una nueva orden.</p>
      <div class="fld"><label>DueÃ±o (WhatsApp)</label><input type="tel" id="cfg-owner" placeholder="+53..."></div>
      <div class="fld"><label>Ayudante Caramelo</label><input type="tel" id="cfg-helper" value="+5355165641"></div>
      <button class="btn btn-y" onclick="guardarNotif()">ğŸ’¾ GUARDAR NÃšMEROS</button>
    </div>

    <hr class="section-divider">

    <div class="cfg-box" style="border-color:var(--red)">
      <h3 style="color:var(--red)">âš ï¸ Zona de Peligro</h3>
      <p style="color:var(--sub);font-size:.85rem;margin-bottom:12px">Borrar historial de Ã³rdenes completadas. Requiere PIN.</p>
      <button class="btn btn-r" style="width:100%" onclick="pedirPinReset()">ğŸ—‘ï¸ RESETEAR HISTORIAL</button>
    </div>
  </div>

</div><!-- /content -->

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script>
// â”€â”€â”€ FIREBASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
firebase.initializeApp({apiKey:"AIzaSyAqQyYN7nxMTRsXcISSNYwESX9JYLsTquI",authDomain:"delbarrioapp-27247.firebaseapp.com",databaseURL:"https://delbarrioapp-27247-default-rtdb.firebaseio.com",projectId:"delbarrioapp-27247",storageBucket:"delbarrioapp-27247.appspot.com",messagingSenderId:"57798249354",appId:"1:57798249354:web:18bd75ac7b8469feb35673"});
const db=firebase.database();

// â”€â”€â”€ GUARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if(!localStorage.getItem('db_admin')){window.location.href='index.html'}

// â”€â”€â”€ ESTADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let comisionGlobal=15,configNotif={owner:'',helper:'+5355165641'};

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function cleanTel(t){return t.replace(/[\s\-\(\)\+]/g,'')}
function toast(msg,err=false){const t=document.getElementById('toast');t.textContent=msg;t.className='toast'+(err?' err':'');t.style.display='block';setTimeout(()=>t.style.display='none',2800)}
function stars(n){return'â­'.repeat(Math.round(n||0))||'â€”'}
function money(n){return'$'+(n||0).toFixed(2)}
function fdate(d){return d||'â€”'}

// â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTab(id,el){
  document.querySelectorAll('.sec').forEach(s=>s.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
  document.getElementById('sec-'+id).classList.add('on');
  el.classList.add('on');
  if(id==='dashboard')renderDash();
  if(id==='ordenes')renderOrdenes();
  if(id==='archivo')renderArchivo();
  if(id==='deudas')renderDeudas();
  if(id==='socios')renderSocios();
  if(id==='config')cargarConfig();
}

function toggleCard(id){
  const c=document.getElementById(id);
  document.querySelectorAll('.card.open').forEach(x=>{if(x.id!==id)x.classList.remove('open')});
  c.classList.toggle('open');
}

// â”€â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDash(){
  db.ref('solicitudes').once('value',snap=>{
    const sol=snap.val()||{};
    const total=Object.keys(sol).length;
    const pend=Object.values(sol).filter(o=>o.estado==='pendiente').length;
    let ing=0;
    Object.values(sol).forEach(o=>{if(o.monto)ing+=o.monto*(configNotif.comGlobal||comisionGlobal)/100});
    document.getElementById('d-total').textContent=total;
    document.getElementById('d-pend').textContent=pend;
    document.getElementById('d-ing').textContent=money(ing);
  });
  db.ref('socios').once('value',snap=>{
    const soc=snap.val()||{};
    document.getElementById('d-socios').textContent=Object.keys(soc).length;
    const arr=Object.entries(soc).map(([id,s])=>({id,...s})).sort((a,b)=>(b.rating||0)-(a.rating||0)).slice(0,5);
    const c=document.getElementById('topSocios');
    c.innerHTML=arr.length?arr.map((s,i)=>`
      <div class="card">
        <div class="card-hdr">
          <div style="display:flex;align-items:center;gap:12px">
            <span class="rank">${i+1}</span>
            <div><div class="card-title">${s.usuario||s.nombre}</div>
            <div class="card-sub">${s.especialidad||'â€”'} Â· ${s.trabajos||0} trabajos</div></div>
          </div>
          <span style="color:var(--y);font-size:.85rem">${stars(s.rating)}</span>
        </div>
      </div>`).join(''):'<p style="color:var(--sub);text-align:center;padding:20px">Sin socios aÃºn</p>';
  });
}

// â”€â”€â”€ Ã“RDENES PENDIENTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderOrdenes(){
  const c=document.getElementById('listaOrdenes');
  db.ref('solicitudes').on('value',snap=>{
    const sol=snap.val()||{};
    const pend=Object.entries(sol).filter(([,o])=>o.estado==='pendiente').sort((a,b)=>b[1].fecha_inicio>a[1].fecha_inicio?1:-1);
    if(!pend.length){c.innerHTML='<p style="color:var(--sub);text-align:center;padding:30px">Sin Ã³rdenes pendientes ğŸ‰</p>';return}
    c.innerHTML=pend.map(([id,o])=>{
      const tc=cleanTel(o.telefono||'');
      return`<div class="card hl" id="ord-${id}">
        <div class="card-hdr" onclick="toggleCard('ord-${id}')">
          <div><div class="card-title">${o.cliente}</div>
          <div class="card-sub">${o.categoria||'General'} Â· ${fdate(o.fecha_inicio)}</div></div>
          <div style="display:flex;align-items:center;gap:8px">
            <span class="badge badge-r">PENDIENTE</span><span class="arrow">â–¼</span>
          </div>
        </div>
        <div class="card-body">
          <div class="irow"><span class="ilbl">DirecciÃ³n</span><span class="ival">${o.direccion||'â€”'}</span></div>
          <div class="irow"><span class="ilbl">Problema</span><span class="ival">${o.problema||'â€”'}</span></div>
          <div class="irow"><span class="ilbl">TelÃ©fono</span><span class="ival">${o.telefono||'â€”'}</span></div>
          <div class="irow"><span class="ilbl">TÃ©cnico</span><span class="ival" id="tec-${id}">â€”</span></div>
          <div class="fld" style="margin-top:14px"><label>Asignar TÃ©cnico</label>
            <select id="sel-${id}"><option value="">Seleccionar...</option></select>
          </div>
          <button class="btn btn-y" onclick="asignarTecnico('${id}')">ğŸ“¤ ASIGNAR Y NOTIFICAR</button>
          <button class="btn btn-g" onclick="window.open('https://wa.me/${tc}','_blank')">ğŸ’¬ WhatsApp Cliente</button>
          <button class="btn btn-b" onclick="window.open('tel:+${tc}','_blank')">ğŸ“ Llamar</button>
        </div>
      </div>`;
    }).join('');
    // Cargar socios en selects
    db.ref('socios').once('value',sSnap=>{
      const soc=sSnap.val()||{};
      pend.forEach(([id,o])=>{
        const sel=document.getElementById('sel-'+id);
        if(!sel)return;
        Object.entries(soc).forEach(([sid,s])=>{
          if(s.admitido){
            const opt=document.createElement('option');
            opt.value=sid;
            opt.dataset.tel=s.telefono||'';
            opt.dataset.nom=s.usuario||s.nombre||'';
            opt.textContent=`${s.disponible?'ğŸŸ¢':'ğŸ”´'} ${s.usuario||s.nombre} - ${s.especialidad||''}`;
            sel.appendChild(opt);
          }
        });
        if(o.tecnico){const tv=document.getElementById('tec-'+id);if(tv&&soc[o.tecnico])tv.textContent=soc[o.tecnico].usuario||soc[o.tecnico].nombre||'â€”'}
      });
    });
  });
}

function asignarTecnico(oid){
  const sel=document.getElementById('sel-'+oid);
  const tid=sel.value;
  if(!tid){toast('âš ï¸ Selecciona un tÃ©cnico',true);return}
  const opt=sel.options[sel.selectedIndex];
  const telTec=cleanTel(opt.dataset.tel||'');
  const nomTec=opt.dataset.nom||'TÃ©cnico';
  db.ref('solicitudes/'+oid).once('value',snap=>{
    const o=snap.val()||{};
    db.ref('solicitudes/'+oid).update({tecnico:tid});
    // Notificar tÃ©cnico
    const msgTec=`ğŸ”§ NUEVA ORDEN D'BARRIO\n\nğŸ‘¤ Cliente: ${o.cliente}\nğŸ“ ${o.direccion}\nğŸ·ï¸ ${o.categoria}\nâš™ï¸ ${o.problema}\nğŸ“ Cliente: ${o.telefono}\n\nâœ… Asignado a ti. ContÃ¡ctalo.`;
    window.open(`https://wa.me/${telTec}?text=${encodeURIComponent(msgTec)}`, '_blank');
    // Notificar owner y helper
    [configNotif.owner,configNotif.helper].filter(Boolean).forEach(num=>{
      const n=cleanTel(num);
      if(n){
        const msgAdm=`ğŸ“‹ Orden asignada a ${nomTec}\nCliente: ${o.cliente} Â· ${o.categoria}`;
        setTimeout(()=>window.open(`https://wa.me/${n}?text=${encodeURIComponent(msgAdm)}`, '_blank'),1500);
      }
    });
    toast('âœ… TÃ©cnico asignado y notificado');
  });
}

// â”€â”€â”€ ARCHIVO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderArchivo(){
  const c=document.getElementById('listaArchivo');
  db.ref('solicitudes').on('value',snap=>{
    const sol=snap.val()||{};
    const listos=Object.entries(sol).filter(([,o])=>o.estado==='finalizado_pendiente_recibo');
    if(!listos.length){c.innerHTML='<p style="color:var(--sub);text-align:center;padding:30px">Sin recibos pendientes</p>';return}
    c.innerHTML=listos.map(([id,o])=>{
      const tc=cleanTel(o.telefono||'');
      const fI=new Date(o.fecha_inicio);const fV=new Date(fI);fV.setDate(fV.getDate()+30);
      const vStr=fV.toLocaleDateString('es-CU');
      const recibo=`ğŸ›¡ï¸ RECIBO D'BARRIO\n\nğŸ“‹ CÃ³digo: ${o.codigo_garantia||'â€”'}\nğŸ’µ Total: ${money(o.monto)}\nğŸ“… GarantÃ­a hasta: ${vStr}\n\nâœ… Servicio garantizado 30 dÃ­as\nğŸ“ Soporte: https://wa.me/5355165641`;
      return`<div class="card hl" id="arc-${id}">
        <div class="card-hdr" onclick="toggleCard('arc-${id}')">
          <div><div class="card-title">${o.cliente}</div>
          <div class="card-sub">${money(o.monto)} Â· ${o.categoria||'â€”'}</div></div>
          <div style="display:flex;align-items:center;gap:8px">
            <span class="badge badge-o">RECIBO</span><span class="arrow">â–¼</span>
          </div>
        </div>
        <div class="card-body">
          <div class="irow"><span class="ilbl">CÃ³digo</span><span class="ival">${o.codigo_garantia||'â€”'}</span></div>
          <div class="irow"><span class="ilbl">Monto</span><span class="money">${money(o.monto)}</span></div>
          <div class="irow"><span class="ilbl">Vence</span><span class="ival">${vStr}</span></div>
          <button class="btn btn-y" onclick="enviarRecibo('${id}','${tc}',\`${recibo}\`)">ğŸ“¤ ENVIAR RECIBO Y COMPLETAR</button>
          <button class="btn btn-g" onclick="window.open('https://wa.me/${tc}','_blank')">ğŸ’¬ WhatsApp</button>
        </div>
      </div>`;
    }).join('');
  });
}

function enviarRecibo(oid,tel,msg){
  db.ref('solicitudes/'+oid).update({estado:'completado',fecha_fin:new Date().toLocaleDateString('es-CU')});
  window.open(`https://wa.me/${tel}?text=${encodeURIComponent(msg)}`,'_blank');
  toast('âœ… Recibo enviado');
}

// â”€â”€â”€ DEUDAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDeudas(){
  const c=document.getElementById('listaDeudas');
  db.ref('socios').on('value',snap=>{
    const soc=snap.val()||{};
    const arr=Object.entries(soc).filter(([,s])=>s.admitido);
    if(!arr.length){c.innerHTML='<p style="color:var(--sub);text-align:center;padding:30px">Sin socios admitidos</p>';return}
    c.innerHTML=arr.map(([id,s])=>{
      const tc=cleanTel(s.telefono||'');
      return`<div class="card" id="deu-${id}">
        <div class="card-hdr" onclick="toggleCard('deu-${id}')">
          <div><div class="card-title">${s.usuario||s.nombre} ${stars(s.rating)}</div>
          <div class="card-sub">${s.especialidad||'â€”'} Â· ${s.trabajos||0} trabajos</div></div>
          <div style="display:flex;align-items:center;gap:8px">
            <span class="badge badge-y">${money(s.deuda)}</span><span class="arrow">â–¼</span>
          </div>
        </div>
        <div class="card-body">
          <div class="irow"><span class="ilbl">Zona</span><span class="ival">${s.zona||'â€”'}</span></div>
          <div class="irow"><span class="ilbl">ComisiÃ³n</span><span class="ival">${s.comision||comisionGlobal}%</span></div>
          <div class="irow"><span class="ilbl">Deuda</span><span class="money">${money(s.deuda)}</span></div>
          <button class="btn btn-y" onclick="liquidar('${id}')">ğŸ’° MARCAR LIQUIDADO</button>
          <button class="btn btn-g" onclick="window.open('https://wa.me/${tc}','_blank')">ğŸ’¬ WhatsApp</button>
          <button class="btn btn-b" onclick="window.open('tel:+${tc}','_blank')">ğŸ“ Llamar</button>
        </div>
      </div>`;
    }).join('');
  });
}

function liquidar(sid){
  if(!confirm('Â¿Marcar deuda como liquidada?'))return;
  db.ref('socios/'+sid).update({deuda:0});
  toast('âœ… Deuda liquidada');
}

// â”€â”€â”€ SOCIOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('formSocio').addEventListener('submit',function(e){
  e.preventDefault();
  const nom=document.getElementById('sn-nom').value.trim();
  const tel=document.getElementById('sn-tel').value.trim();
  const zon=document.getElementById('sn-zon').value.trim();
  const esp=document.getElementById('sn-esp').value;
  const pin=document.getElementById('sn-pin').value.trim();
  const com=parseInt(document.getElementById('sn-com').value)||15;
  if(!nom||!tel||!zon||!esp||!pin){toast('âš ï¸ Completa todos los campos',true);return}
  const ref=db.ref('socios').push({
    usuario:nom,telefono:tel,zona:zon,especialidad:esp,pin:pin,
    comision:com,deuda:0,disponible:true,admitido:false,
    rating:0,trabajos:0
  });
  const link=`https://abelbalsinde92-lab.github.io/D-Barrio/socio.html?id=${ref.key}`;
  const msg=`ğŸ‰ Bienvenido a D'BARRIO\n\nâœ… Tu acceso:\n${link}\n\nğŸ” PIN: ${pin}\nâš ï¸ El Admin debe aprobarte antes de entrar.\n\nGuarda este mensaje.`;
  window.open(`https://wa.me/${cleanTel(tel)}?text=${encodeURIComponent(msg)}`,'_blank');
  this.reset();
  toast('âœ… Socio registrado. EnvÃ­a invite y apruÃ©balo.');
  document.getElementById('card-new-socio').classList.remove('open');
  setTimeout(renderSocios,1000);
});

function renderSocios(){
  const c=document.getElementById('listaSocios');
  if(!c)return;
  db.ref('socios').on('value',snap=>{
    const soc=snap.val()||{};
    const arr=Object.entries(soc);
    if(!arr.length){c.innerHTML='<p style="color:var(--sub);text-align:center;padding:20px">Sin socios</p>';return}
    c.innerHTML=arr.map(([id,s])=>{
      const disp=s.disponible?'dot-g':'dot-r';
      const admitido=s.admitido;
      return`<div class="card" id="soc-${id}">
        <div class="card-hdr" onclick="toggleCard('soc-${id}')">
          <div style="display:flex;align-items:center;gap:10px">
            <span class="dot ${disp}"></span>
            <div><div class="card-title">${s.usuario||s.nombre}</div>
            <div class="card-sub">${s.especialidad||'â€”'} Â· ${s.zona||'â€”'}</div></div>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <span class="badge ${admitido?'badge-g':'badge-r'}">${admitido?'ADMITIDO':'PENDIENTE'}</span>
            <span class="arrow">â–¼</span>
          </div>
        </div>
        <div class="card-body">
          <div class="irow"><span class="ilbl">TelÃ©fono</span><span class="ival">${s.telefono||'â€”'}</span></div>
          <div class="irow"><span class="ilbl">PIN</span><span class="ival">${s.pin||'â€”'}</span></div>
          <div class="irow"><span class="ilbl">ComisiÃ³n</span><span class="ival">${s.comision||comisionGlobal}%</span></div>
          <div class="irow"><span class="ilbl">Rating</span><span class="ival">${stars(s.rating)} (${(s.rating||0).toFixed(1)})</span></div>
          <div class="irow"><span class="ilbl">Trabajos</span><span class="ival">${s.trabajos||0}</span></div>
          <div class="irow"><span class="ilbl">Deuda</span><span class="money">${money(s.deuda)}</span></div>
          ${admitido
            ?`<button class="btn btn-r" onclick="toggleAdmitido('${id}',false)">ğŸš« REVOCAR ACCESO</button>`
            :`<button class="btn btn-g" onclick="toggleAdmitido('${id}',true)">âœ… ADMITIR AL SISTEMA</button>`}
          <button class="btn btn-r" style="margin-top:6px" onclick="eliminarSocio('${id}')">ğŸ—‘ï¸ ELIMINAR</button>
        </div>
      </div>`;
    }).join('');
  });
}

function toggleAdmitido(id,val){db.ref('socios/'+id).update({admitido:val});toast(val?'âœ… Socio admitido':'âš ï¸ Acceso revocado')}
function eliminarSocio(id){if(!confirm('Â¿Eliminar socio?'))return;db.ref('socios/'+id).remove();toast('âœ… Eliminado')}

// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function cargarConfig(){
  db.ref('config').once('value',snap=>{
    const c=snap.val()||{};
    document.getElementById('cfg-com').value=c.comision||15;
    document.getElementById('cfg-owner').value=c.owner||'';
    document.getElementById('cfg-helper').value=c.helper||'+5355165641';
    comisionGlobal=c.comision||15;
    configNotif={owner:c.owner||'',helper:c.helper||'+5355165641',comGlobal:c.comision||15};
  });
}

function guardarConfig(){
  const n=parseInt(document.getElementById('cfg-com').value)||15;
  comisionGlobal=n;
  db.ref('config').update({comision:n});
  toast('âœ… ComisiÃ³n guardada');
}

function guardarNotif(){
  const o=document.getElementById('cfg-owner').value.trim();
  const h=document.getElementById('cfg-helper').value.trim();
  db.ref('config').update({owner:o,helper:h});
  configNotif.owner=o;configNotif.helper=h;
  toast('âœ… NÃºmeros guardados');
}

// â”€â”€â”€ RESET SISTEMA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pedirPinReset(){document.getElementById('overlay-pin').classList.add('open');document.getElementById('reset-pin').value='';document.getElementById('reset-pin').focus()}
function closeOverlay(){document.getElementById('overlay-pin').classList.remove('open')}
function confirmarReset(){
  const pin=document.getElementById('reset-pin').value;
  if(pin!=='9202'){toast('âš ï¸ PIN incorrecto',true);return}
  db.ref('solicitudes').once('value',snap=>{
    const sol=snap.val()||{};
    const updates={};
    Object.entries(sol).forEach(([id,o])=>{if(o.estado==='completado')updates[id]=null});
    db.ref('solicitudes').update(updates).then(()=>{toast('âœ… Historial limpiado');closeOverlay()});
  });
}

// â”€â”€â”€ LOGOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelector('.hdr-back').addEventListener('click',function(e){
  e.preventDefault();localStorage.removeItem('db_admin');window.location.href='index.html';
});

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cargarConfig();
renderDash();
db.ref('config').on('value',snap=>{const c=snap.val()||{};comisionGlobal=c.comision||15;configNotif={owner:c.owner||'',helper:c.helper||'+5355165641',comGlobal:c.comision||15}});
if('serviceWorker' in navigator)navigator.serviceWorker.register('sw.js').catch(()=>{});
</script>
</body>
</html>
