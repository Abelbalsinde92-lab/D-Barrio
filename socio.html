<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>D'BARRIO - Mi Panel</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#F9A825">
<link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root{--y:#F9A825;--bg:#000;--card:#111;--card2:#1a1a1a;--border:#2a2a2a;--text:#fff;--sub:#aaa;--red:#ff4444;--green:#00d856}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto Condensed',sans-serif}
html,body{background:var(--bg);color:var(--text);min-height:100vh}
body{padding-bottom:80px}
.hdr{background:var(--card);border-bottom:3px solid var(--y);padding:14px 18px;position:sticky;top:0;z-index:100;display:flex;justify-content:space-between;align-items:center}
.hdr-logo{font-size:1.2rem;font-weight:900;color:var(--y);text-transform:uppercase}
.hdr-back{background:rgba(249,168,37,.15);border:2px solid var(--y);color:var(--y);padding:7px 14px;font-size:.75rem;font-weight:900;text-decoration:none;text-transform:uppercase}
.tabs{background:var(--card);border-bottom:3px solid var(--border);display:flex;position:sticky;top:55px;z-index:99}
.tab{padding:13px 0;font-size:.7rem;font-weight:900;text-transform:uppercase;color:var(--sub);border-bottom:3px solid transparent;cursor:pointer;flex:1;text-align:center}
.tab.on{color:var(--y);border-bottom-color:var(--y)}
.content{padding:18px;max-width:900px;margin:0 auto}
.sec{display:none}
.sec.on{display:block}
h2{color:var(--y);font-size:1.3rem;font-weight:900;text-transform:uppercase;border-bottom:3px solid var(--y);padding-bottom:8px;margin-bottom:18px}
.stats-toggle{background:var(--y);color:#000;padding:13px 18px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;font-weight:900;font-size:.9rem;text-transform:uppercase;margin-bottom:0}
.stats-toggle .sarrow{font-size:.85rem;transition:transform .3s}
.stats-toggle.open .sarrow{transform:rotate(180deg)}
.stats-body{background:var(--card2);border:3px solid var(--y);border-top:none;padding:0;max-height:0;overflow:hidden;transition:max-height .4s ease,padding .3s ease;margin-bottom:16px}
.stats-body.open{padding:16px;max-height:800px}
.irow{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid var(--border);gap:10px}
.irow:last-child{border:none}
.ilbl{color:var(--sub);font-size:.78rem;font-weight:700}
.ival{color:#fff;font-weight:900;font-size:.85rem;text-align:right}
.money{color:var(--y);font-weight:900;font-size:1.05rem}
.toggle-row{display:flex;align-items:center;gap:14px;background:#000;border:2px solid var(--border);padding:14px;margin-top:12px}
.tswitch{width:52px;height:26px;background:#333;border-radius:3px;position:relative;transition:background .2s;pointer-events:none;opacity:.5}
.tswitch.on{background:var(--y)}
.tswitch::after{content:'';position:absolute;width:20px;height:20px;background:#000;top:3px;left:3px;transition:left .2s}
.tswitch.on::after{left:29px}
.tlabel{font-weight:900;font-size:.9rem;flex:1;text-transform:uppercase;color:#fff}
.tstatus{font-size:.7rem;font-weight:900;padding:5px 10px}
.tstatus.disp{background:rgba(0,216,86,.2);color:var(--green)}
.tstatus.ocup{background:rgba(255,68,68,.2);color:var(--red)}
.card{background:var(--card);border:3px solid var(--border);margin-bottom:12px;box-shadow:0 4px 0 #000}
.card.hl{border-color:var(--y);box-shadow:0 4px 0 #c17900}
.card-hdr{padding:15px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;gap:10px}
.card-title{font-weight:900;font-size:.95rem;text-transform:uppercase;color:#fff}
.card-sub{font-size:.7rem;color:var(--sub);margin-top:3px}
.card-body{padding:0 15px;max-height:0;overflow:hidden;transition:max-height .4s ease,padding .3s ease}
.card.open .card-body{padding:15px;max-height:4000px}
.arrow{color:var(--y);font-size:.9rem;transition:transform .3s}
.card.open .arrow{transform:rotate(180deg)}
.badge{padding:4px 10px;font-size:.62rem;font-weight:900;text-transform:uppercase}
.badge-r{background:var(--red);color:#fff;animation:pulse 2s infinite}
.badge-g{background:var(--green);color:#000}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
.btn{padding:12px 18px;border:none;font-family:'Roboto Condensed',sans-serif;font-weight:900;font-size:.85rem;cursor:pointer;text-transform:uppercase;display:block;width:100%;margin:6px 0}
.btn-y{background:var(--y);color:#000;box-shadow:0 4px 0 #c17900}
.btn-y:active{transform:translateY(4px);box-shadow:none}
.btn-g{background:transparent;border:2px solid var(--green);color:var(--green)}
.btn-b{background:transparent;border:2px solid #0088ff;color:#0088ff}
.fld{margin-bottom:12px}
.fld label{display:block;font-size:.62rem;font-weight:900;color:var(--sub);text-transform:uppercase;margin-bottom:5px}
.fld input{width:100%;background:#000;border:2px solid var(--border);color:#fff;padding:12px;font-family:'Roboto Condensed',sans-serif;font-size:.9rem;font-weight:700}
.fld input:focus{outline:none;border-color:var(--y)}
.fin-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px}
.fin-box{background:var(--card2);border:3px solid var(--border);padding:16px;text-align:center}
.fin-val{font-size:1.5rem;font-weight:900;color:var(--y);line-height:1}
.fin-lbl{font-size:.6rem;color:var(--sub);text-transform:uppercase;margin-top:5px;font-weight:700}
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%);background:var(--y);color:#000;padding:13px 22px;font-weight:900;font-size:.9rem;z-index:9999;text-align:center;min-width:240px;display:none}
.toast.err{background:var(--red);color:#fff}
.blocked{position:fixed;inset:0;background:#000;z-index:9999;display:none;flex-direction:column;align-items:center;justify-content:center;padding:30px;text-align:center}
.blocked.show{display:flex}
.blocked h2{color:var(--y);font-size:1.5rem;margin-bottom:16px}
.blocked p{color:var(--sub);margin-bottom:24px;line-height:1.6}
.empty{color:var(--sub);text-align:center;padding:30px;font-size:.9rem}
</style>
</head>
<body>

<div class="toast" id="toast"></div>
<div class="blocked" id="blocked">
  <h2>‚õî ACCESO DENEGADO</h2>
  <p id="blocked-msg">Verificando...</p>
  <a href="index.html" style="background:var(--y);color:#000;padding:14px 28px;font-weight:900;text-decoration:none;text-transform:uppercase">VOLVER</a>
</div>

<div id="app-content" style="display:none">
  <div class="hdr">
    <a href="index.html" class="hdr-back">‚Üê VOLVER</a>
    <div class="hdr-logo" id="hdr-nombre">D'BARRIO</div>
    <div style="width:72px"></div>
  </div>

  <div class="tabs">
    <div class="tab on" onclick="showTab('activas')">üìã ACTIVAS</div>
    <div class="tab" onclick="showTab('historial')">üìä HISTORIAL</div>
    <div class="tab" onclick="showTab('stats')">üí∞ FINANZAS</div>
  </div>

  <div class="content">
    <div>
      <div class="stats-toggle" onclick="toggleStats()">
        <span>‚≠ê MIS DATOS</span>
        <span class="sarrow">‚ñº</span>
      </div>
      <div class="stats-body" id="stats-body">
        <div class="irow"><span class="ilbl">CALIFICACI√ìN</span><span class="ival" id="s-rating">‚≠ê 0.0</span></div>
        <div class="irow"><span class="ilbl">TRABAJOS</span><span class="ival" id="s-trabajos">0</span></div>
        <div class="irow"><span class="ilbl">DEUDA</span><span class="money" id="s-deuda">$0.00</span></div>
        <div class="irow"><span class="ilbl">ZONA</span><span class="ival" id="s-zona">‚Äî</span></div>
        <div class="irow"><span class="ilbl">COMISI√ìN</span><span class="ival" id="s-comision">15%</span></div>
        <div class="toggle-row">
          <div class="tswitch" id="tswitch"></div>
          <span class="tlabel">DISPONIBILIDAD</span>
          <span class="tstatus ocup" id="tstatus">üî¥ OCUPADO</span>
        </div>
        <p style="font-size:.7rem;color:var(--sub);margin-top:8px;text-align:center">ü§ñ Autom√°tico: ocupado si tienes √≥rdenes activas</p>
      </div>
    </div>

    <div id="sec-activas" class="sec on">
      <h2>üìã √ìrdenes Activas</h2>
      <div id="listaActivas"><p class="empty">Cargando...</p></div>
    </div>

    <div id="sec-historial" class="sec">
      <h2>üìä Historial</h2>
      <div id="listaHistorial"><p class="empty">Cargando...</p></div>
    </div>

    <div id="sec-stats" class="sec">
      <h2>üí∞ Finanzas</h2>
      <div class="fin-grid">
        <div class="fin-box"><div class="fin-val" id="f-total">$0</div><div class="fin-lbl">Total</div></div>
        <div class="fin-box"><div class="fin-val" id="f-neto">$0</div><div class="fin-lbl">Neto</div></div>
        <div class="fin-box"><div class="fin-val" id="f-mes">$0</div><div class="fin-lbl">Este Mes</div></div>
        <div class="fin-box"><div class="fin-val" id="f-prom">$0</div><div class="fin-lbl">Promedio</div></div>
      </div>
      <div id="statsDetalle"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL='https://jtorpamexbjxnomngfwq.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0b3JwYW1leGJqeG5vbW5nZndxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MjE2MjMsImV4cCI6MjA4Njk5NzYyM30.Tzun90wyUfPYb8K8WxmziwlKyJS8kY1K_zzrZNh7R-8';
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

const params=new URLSearchParams(window.location.search);
const socioId=params.get('id')||localStorage.getItem('db_socio_id');
let socioData={};
let comisionSocio=15;
let ordenesActivas=0;

// Utilidades
function ct(t){return (t||'').replace(/[\s\-\(\)\+]/g,'')}
function money(n){return '$'+(parseFloat(n)||0).toFixed(2)}
function toast(msg,err){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='toast'+(err?' err':'');
  t.style.display='block'; setTimeout(()=>t.style.display='none',2800);
}
function mostrarBloqueado(msg){
  document.getElementById('blocked-msg').textContent=msg;
  document.getElementById('blocked').classList.add('show');
  document.getElementById('app-content').style.display='none';
}
function mostrarApp(){
  document.getElementById('blocked').classList.remove('show');
  document.getElementById('app-content').style.display='block';
}
function toggleCard(id){ document.getElementById(id).classList.toggle('open'); }
function toggleStats(){
  document.getElementById('stats-body').classList.toggle('open');
  document.querySelector('.stats-toggle').classList.toggle('open');
}
function showTab(tab){
  document.querySelectorAll('.sec').forEach(s=>s.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
  document.getElementById('sec-'+tab).classList.add('on');
  event.currentTarget.classList.add('on');
  if(tab==='historial') renderHistorial();
  if(tab==='stats') renderFinanzas();
}
function actualizarToggle(ocupado){
  const sw=document.getElementById('tswitch');
  const st=document.getElementById('tstatus');
  if(ocupado){ sw.classList.add('on'); st.className='tstatus ocup'; st.textContent='üî¥ OCUPADO'; }
  else { sw.classList.remove('on'); st.className='tstatus disp'; st.textContent='üü¢ DISPONIBLE'; }
}

// Inicio y Verificaci√≥n
if(!socioId){
  mostrarBloqueado('ID no v√°lido. Pide tu enlace al admin.');
} else {
  (async()=>{
    localStorage.setItem('db_socio_id', socioId);
    const {data:s, error} = await sb.from('socios').select('*').eq('id', socioId).single();
    if(error || !s){ mostrarBloqueado('Socio no encontrado.'); return; }
    socioData = s;
    comisionSocio = s.comision || 15;
    mostrarApp();
    await cargarDatosSocio();
    await renderActivas();
    setInterval(async()=>{
      const {data:soc} = await sb.from('socios').select('*').eq('id', socioId).single();
      if(soc){ socioData = soc; await cargarDatosSocio(); }
    }, 15000);
  })()
}

async function cargarDatosSocio(){
  const s=socioData;
  const nom=s.usuario||s.nombre||'T√©cnico';
  document.getElementById('hdr-nombre').textContent="D'"+nom.split(' ')[0].toUpperCase();
  document.getElementById('s-rating').textContent='‚≠ê '+(s.rating||0).toFixed(1);
  document.getElementById('s-trabajos').textContent=s.trabajos||0;
  document.getElementById('s-deuda').textContent=money(s.deuda);
  document.getElementById('s-zona').textContent=s.zona||'‚Äî';
  document.getElementById('s-comision').textContent=(s.comision||15)+'%';
  
  const {data:ordenes} = await sb.from('solicitudes').select('*').eq('socio_asignado',socioId).eq('estado','pendiente');
  ordenesActivas = ordenes ? ordenes.length : 0;
  const ocupado = ordenesActivas > 0;
  actualizarToggle(ocupado);
  
  if(ocupado !== !s.disponible){
    await sb.from('socios').update({disponible:!ocupado}).eq('id',socioId);
  }
}

async function renderActivas(){
  const c = document.getElementById('listaActivas');
  const {data:sol} = await sb.from('solicitudes').select('*').eq('socio_asignado', socioId).eq('estado', 'pendiente').order('created_at', {ascending: false});
  if(!sol || sol.length === 0){ c.innerHTML = '<p class="empty">No tienes √≥rdenes activas</p>'; return; }
  c.innerHTML = sol.map(o => `
    <div class="card hl open" id="ord-${o.id}">
      <div class="card-hdr">
        <div><div class="card-title">${o.cliente}</div><div class="card-sub">${o.servicio} ¬∑ ${o.municipio || ''}</div></div>
        <span class="badge badge-r">NUEVA</span>
      </div>
      <div class="card-body">
        <div class="irow"><span class="ilbl">Direcci√≥n:</span><span class="ival">${o.direccion}</span></div>
        <div class="irow"><span class="ilbl">Tel√©fono:</span><span class="ival">${o.telefono}</span></div>
        <button class="btn btn-g" onclick="window.open('https://wa.me/${ct(o.telefono)}','_blank')">üí¨ WHATSAPP CLIENTE</button>
        <div class="fld" style="margin-top:15px">
          <label>MONTO TOTAL COBRADO ($)</label>
          <input type="number" id="monto-${o.id}" placeholder="0.00" inputmode="numeric">
        </div>
        <button class="btn btn-y" onclick="finalizarTrabajo('${o.id}', '${(o.cliente||'').replace(/'/g,"")}')">‚úÖ REPORTAR TRABAJO</button>
      </div>
    </div>`).join('');
}

async function finalizarTrabajo(id, cliente) {
  const mInput = document.getElementById(`monto-${id}`);
  const monto = parseFloat(mInput.value);
  
  if (!monto || monto <= 0) { 
    toast('‚ö†Ô∏è Ingresa el monto cobrado', true); 
    return; 
  }

  // 1. Calculamos comisi√≥n y nueva deuda
  const comision = monto * (comisionSocio / 100);
  const nuevaDeuda = (socioData.deuda || 0) + comision;
  const nuevoTotalTrabajos = (socioData.trabajos || 0) + 1;

  // 2. Bloqueamos el bot√≥n para evitar doble env√≠o (Conexi√≥n lenta Cuba)
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = "PROCESANDO...";

  try {
    // 3. Actualizamos la solicitud
    await sb.from('solicitudes').update({
      estado: 'completada', 
      monto: monto, 
      fecha_fin: new Date().toLocaleDateString('es-CU')
    }).eq('id', id);

    // 4. Actualizamos al socio (Deuda y contador de trabajos)
    await sb.from('socios').update({
      deuda: nuevaDeuda, 
      trabajos: nuevoTotalTrabajos
    }).eq('id', socioId);

    // 5. Mensaje para Caramelo (Administraci√≥n)
    const msgAdmin = `‚úÖ *TRABAJO TERMINADO*\n\nüë∑ Socio: ${socioData.nombre}\nüë§ Cliente: ${cliente}\nüí∞ Cobrado: $${monto}\nüìâ Comisi√≥n: $${comision.toFixed(2)}\nüìå Deuda total: $${nuevaDeuda.toFixed(2)}`;
    
    // 6. Mensaje para el Cliente (Valoraci√≥n)
    const msgCliente = `‚úÖ *D'BARRIO - SERVICIO FINALIZADO*\n\nHola ${cliente}, su servicio ha concluido.\n\n‚≠ê *Valore mi trabajo aqu√≠:* \nhttps://abelbalsinde92-lab.github.io/D-Barrio/index.html?id=DB-${id}\n\n¬°Muchas gracias!`;

    // Abrimos WhatsApp para notificar a Caramelo
    window.open(`https://wa.me/5355165641?text=${encodeURIComponent(msgAdmin)}`, '_blank');
    
    // Mostramos el link de valoraci√≥n para que el socio lo copie y env√≠e al cliente
    alert(`¬°TRABAJO GUARDADO!\n\nEnv√≠a este mensaje a tu cliente para que te califique:\n\n${msgCliente}`);

    toast('‚úÖ Reporte enviado con √©xito');
    renderActivas();
    
  } catch (err) {
    toast('‚ùå Error de conexi√≥n', true);
    btn.disabled = false;
    btn.textContent = "‚úÖ REPORTAR TRABAJO";
  }
}

async function renderHistorial(){
  const c = document.getElementById('listaHistorial');
  const {data:sol} = await sb.from('solicitudes')
    .select('*')
    .eq('socio_asignado', socioId)
    .neq('estado', 'pendiente')
    .order('created_at', {ascending: false});
  
  if(!sol || !sol.length){ c.innerHTML = '<p class="empty">No hay historial disponible</p>'; return; }
  
    c.innerHTML = sol.map(o => {
    const tieneG = o.codigo_garantia ? 'border-left: 5px solid var(--y)' : '';
    // L√≥gica de estrellas por cada trabajo
    const estrellas = o.valoracion ? '‚≠ê'.repeat(o.valoracion) : '<span style="color:var(--sub)">Sin calificar</span>';

    return `
    <div class="card" id="his-${o.id}" style="${tieneG}">
      <div class="card-hdr" onclick="toggleCard('his-${o.id}')">
        <div>
          <div class="card-title">${o.cliente || '‚Äî'}</div>
          <div class="card-sub">${o.fecha_fin || '‚Äî'} ¬∑ ${o.servicio}</div>
        </div>
        <div style="text-align:right">
           <div style="font-size:0.8rem">${estrellas}</div>
           <span class="arrow">‚ñº</span>
        </div>
      </div>
      <div class="card-body">
        <div class="irow"><span class="ilbl">Monto Cobrado</span><span class="money">${money(o.monto)}</span></div>
        <div class="irow"><span class="ilbl">Comisi√≥n (${comisionSocio}%)</span><span class="ival">${money(o.monto * (comisionSocio/100))}</span></div>
        <div class="irow"><span class="ilbl">ID Servicio</span><span class="ival" style="font-family:monospace">DB-${o.id}</span></div>
        ${o.codigo_garantia ? `<div style="margin-top:8px"><span class="badge" style="background:var(--y); color:#000; padding:4px 8px">üõ°Ô∏è GARANT√çA ACTIVA</span></div>` : ''}
      </div>
    </div>`;
  }).join('');

async function renderFinanzas(){
  const {data:sol}=await sb.from('solicitudes').select('*').eq('socio_asignado',socioId).not('monto','is',null);
  let total=0, neto=0, count=0;
  if(sol){
    sol.forEach(o=>{
      total+=o.monto;
      neto+=(o.monto - (o.monto*(comisionSocio/100)));
      count++;
    });
  }
  document.getElementById('f-total').textContent=money(total);
  document.getElementById('f-neto').textContent=money(neto);
  document.getElementById('f-mes').textContent=money(socioData.deuda);
  document.getElementById('f-prom').textContent=count>0?money(total/count):'$0';
  document.getElementById('statsDetalle').innerHTML=`
    <div class="card">
      <div class="card-body" style="max-height:none; padding:15px">
        <div class="irow"><span class="ilbl">Trabajos realizados</span><span class="ival">${count}</span></div>
        <div class="irow"><span class="ilbl">Comisi√≥n pactada</span><span class="ival">${comisionSocio}%</span></div>
        <div class="irow"><span class="ilbl">Deuda pendiente</span><span class="money">${money(socioData.deuda)}</span></div>
      </div>
    </div>`;
}

if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});

</script>
</body>
</html>